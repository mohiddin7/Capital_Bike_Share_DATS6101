---
title: "CaBi Modeling (sampling and NoCovid years)"
author: "TEAM SIM"
date: "2023-04-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Categorical Variables Test

### ANOVA for all Categorical Variables

```{r}
#Making sure the all the variables are in correct datatypes
summary(CaBi)
```

Instead of doing the sampling with the large data, we mutated the `noofbikes` with the group of `started_at` which was previously did with both `started_at` and `start_station_name`. Droped the few variables(`started_at`,`start_station_name`,`member_type`,`duration`,`month`,`year`) with are not required during the modeling.

```{r}


# option 1 for choosing only the date filter and rows will the noof days from october 2010

# CaBiO <- CaBi
CaBi <- CaBiO[, -c(2,3,4,16)]
CaBi <- CaBi %>% 
  group_by(started_at) %>% 
  mutate(noofbikes = sum(noofbikes)) %>% 
  distinct(started_at, .keep_all = TRUE) %>% 
  arrange(started_at)



CaBiforcovid <- CaBi[, -c(1)]
CaBi <- CaBi[, -c(1,13)]



# Option 2 for the sampling selecting 10k rows from the large set

# 
# # Set seed for reproducibility
# set.seed(123)
# 
# # Randomly select 10000 observations
# CaBi <- CaBiO[sample(nrow(CaBiO), 10000), ]
# summary(CaBi)
# 
# write.csv(CaBi,file = "CaBi_Sampled10k.csv",row.names = F)




# # Set seed for reproducibility
# set.seed(123)
# 
# # Randomly select 10000 observations
# CaBitest <- CaBiO[sample(nrow(CaBiO), 5000), ]
# summary(CaBitest)
# CaBitest <- subset(CaBitest, select = -c(started_at, start_station_name,member_type,duration,month,year))
# summary(CaBitest)
# 
# summary(CaBitrain)


```

The total noof rows now changes to `r nrow(CaBi)` from `r nrow(CaBiO)`.

```{r}
library(ggplot2)


# Create violin plot for season
ggplot(CaBi, aes(x=season, y=noofbikes)) + 
  geom_violin() +
  labs(title = "Bike Rentals by Season", x = "Season", y = "Number of Bikes Rented")

summary(aov(noofbikes~season,data=CaBi))

```

```{r}
# Create violin plot for holiday
ggplot(CaBi, aes(x=holiday, y=noofbikes)) + 
  geom_violin() +
  labs(title = "Bike Rentals by Holiday", x = "Holiday", y = "Number of Bikes Rented")

summary(aov(noofbikes~holiday,data=CaBi))

```

```{r}
# Create violin plot for weekday
ggplot(CaBi, aes(x=weekday, y=noofbikes)) + 
  geom_violin() +
  labs(title = "Bike Rentals by Weekday", x = "Weekday", y = "Number of Bikes Rented")

summary(aov(noofbikes~weekday,data=CaBi))

```

```{r}
# Create violin plot for weather
ggplot(CaBi, aes(x=weather, y=noofbikes)) + 
  geom_violin() +
  labs(title = "Bike Rentals by Weather", x = "Weather", y = "Number of Bikes Rented")

summary(aov(noofbikes~weather,data=CaBi))

```



# Modeling

### Linear Regression for Numeric variables Induvidually

#### temperature vs noofbikes

```{r}
library(ggplot2)

# create scatter plot
te <- ggplot(data = CaBi, aes(x = temperature, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "temperature vs noofbikes",
       x = "temperature",
       y = "noofbikes")

ggplotly(te)

summary(lm(noofbikes ~ temperature, data = CaBi))

```

#### feelsliketemp vs noofbikes

```{r}
library(ggplot2)

# create scatter plot
fte <- ggplot(data = CaBi, aes(x = feelsliketemp, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "feelsliketemp vs noofbikes",
       x = "feelsliketemp",
       y = "noofbikes")

ggplotly(fte)

summary(lm(noofbikes ~ feelsliketemp, data = CaBi))

```

#### Dew vs noofbikes

```{r}
library(ggplot2)
library(plotly)

# create scatter plot
de <- ggplot(data = CaBi, aes(x = dew, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "Dew vs noofbikes",
       x = "Dew",
       y = "noofbikes")

# convert ggplot to plotly object
ggplotly(de)

summary(lm(noofbikes ~ dew, data = CaBi))

```

#### humidity vs noofbikes

```{r}
library(ggplot2)
library(plotly)

# create scatter plot
hu <- ggplot(data = CaBi, aes(x = humidity, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "humidity vs noofbikes",
       x = "humidity",
       y = "noofbikes")

# convert ggplot to plotly object
ggplotly(hu)
summary(lm(noofbikes ~ humidity, data = CaBi))


```

#### windspeed vs noofbikes

```{r}
library(ggplot2)
library(plotly)

# create scatter plot
wi <- ggplot(data = CaBi, aes(x = windspeed, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "windspeed vs noofbikes",
       x = "windspeed",
       y = "noofbikes")

# convert ggplot to plotly object
ggplotly(wi)
summary(lm(noofbikes ~ windspeed, data = CaBi))

```

#### uvindex vs noofbikes

```{r}
library(ggplot2)
library(plotly)

# create scatter plot
uv <- ggplot(data = CaBi, aes(x = uvindex, y = noofbikes)) +
  geom_point(size = 0.5) +
  
  # add regression line
  geom_smooth(method = "lm", se = FALSE) +
  
  # add axis labels and title
  labs(title = "uvindex vs noofbikes",
       x = "uvindex",
       y = "noofbikes")

# convert ggplot to plotly object
ggplotly(uv)
summary(lm(noofbikes ~ uvindex, data = CaBi))

```

### Spliting the Data

```{r}
library(caret)

# Set seed for reproducibility
set.seed(123)

# Split data into 80% training and 20% testing
train_index <- createDataPartition(CaBi$noofbikes, p = 0.8, list = FALSE)
CaBitrain <- CaBi[train_index, ]
CaBitest <- CaBi[-train_index, ]

# droping feelsliketemp as is similar to temprature 
CaBitrain <- CaBitrain[, -c(3)]
CaBitest <- CaBitest[, -c(3)]

# Checking the both the data points are same type are not
summary(CaBitrain)
summary(CaBitest)
```

The total noof observations from the Training data `CaBitrain` is `r nrow(CaBitrain)` observations and in test data set `CaBitest` is `r nrow(CaBitest)` observations

### Step Linear Regression Model for Numeric Variables

```{r}
# Fit a full model with all predictors
full_model <- lm(noofbikes ~ temperature  + dew + humidity + windspeed + uvindex, data = CaBitrain)

# Perform a backward stepwise regression
step_model <- step(full_model, direction = "backward")
summary(step_model)

```

The initial AIC value is 58835.95, and the final AIC value after fitting the linear regression model is 58836. This indicates that the model with all the predictor variables, `temperature`, `dew`, `humidity`, `windspeed`, and `uvindex`, is a good fit for the data.

The R-squared value of the model is 0.3202, indicating that 32.02% of the variance in `noofbikes` can be explained by the predictor variables in the model. The adjusted R-squared value is 0.3193, which adjusts for the number of predictor variables in the model.

Overall, the results suggest that the combination of `temperature`, `dew`, `humidity`, `windspeed`, and `uvindex` can be used to predict the number of bikes rented in CaBitrain.


### Linear Regression Model for all Variables

```{r}
library(caret)
library(lift)
set.seed(123)

# Define the training control with 10-fold cross-validation
train_control <- trainControl(method = "cv", number = 10)

# Train the model using linear regression and 10-fold cross-validation
model <- train(noofbikes ~ ., data = CaBitrain, method = "lm", trControl = train_control)

# Print the summary of the model
summary(model)

```

The first model, which includes all five independent variables (`temperature`, `dew`, `humidity`, `windspeed`, and `uvindex`), has an adjusted R-squared value of 0.3193, indicating that these variables explain 31.93% of the variability in the dependent variable. The F-statistic is significant (p-value \< 2.2e-16), indicating that the model is a good fit.

The second model includes all of the independent variables from the first model, as well as additional categorical variables (`weather`, `weekday`, `holiday`, and `season`). This model has an adjusted R-squared value of 0.3961, indicating that these variables explain 39.61% of the variability in the dependent variable. The F-statistic is also significant (p-value \< 2.2e-16), indicating that the model is a good fit.

In both models, `temperature`, `dew`, `humidity`, `windspeed`, and `uvindex` are all significant predictors of `noofbikes`. Additionally, certain categories of the categorical variables are also significant predictors `(i.e., weatherOvercast, weatherOvercastRain, weatherRain, seasonSpring, seasonSummer, and seasonWinter)`. The other categorical variables `(weatherCloudy, weatherOvercastSnow, weekdayWeekend, and holidayNot holiday)` are not significant predictors of `noofbikes`.
